---
title: "Predicting Graduation Rates"
output: github_document
---

```{r}
library(tidyverse)
library(tidymodels)
```


ELS Data needs to be downloaded from:

https://nces.ed.gov/EDAT/Data/Zip/ELS_2002-12_PETS_v1_0_Student_R_Datasets.zip

The zip file needs to opened up in your working directory so the code below will work. 

## Directory structure
```{r}
rddir<-"../../data/raw/"
cddir<-"../../data/cleaned/"
```

## Pipe Function
```{r}
## Ben: what's the pipe function for paste0? could use it here
```

Analysis Variables
```{r}
# Create vector of selected variables
keepvars <- tolower(c(
   "stu_id", ## Student ID
   "sch_id", ## School ID
   "strat_id", ## Stratum ID
   "psu", ## Primary sampling unit
   "BYRACE", ##  Race
   "BYSES1", ## SEs
   "BYINCOME", ## Income
   "BYPARED", ## Parental Education
   "BYNELS2M", ## Math Score
   "BYNELS2R", ## Reading Score
   "F3ATTAINMENT", ## Atainment
   "F2PS1SEC" ##First inst attended
   ))
```


```{r}
# Load R Data File
if(file.exists(paste0(cddir,"els.Rds"))==FALSE){

load(paste0(rddir,"els_02_12_byf3pststu_v1_0.rdata"))

els<-els_02_12_byf3pststu_v1_0

rm(els_02_12_byf3pststu_v1_0)

names(els)<-tolower(names(els))

keepvars<-tolower(keepvars)

els%>%
   select(one_of(keepvars))->els


save(els,file=paste0(cddir,"els.Rds"))
} else {
load(paste0(cddir,"els.rds"))
}
```

## Recoding 
```{r}
## recode all less than -3 as missing

els<-els%>%mutate_all( ~ifelse(.x< (-3) , NA, .x))

miss_vars<-c(-1,-4,-8,-9)
els<-els%>%mutate_all( ~ifelse(.x%in% miss_vars , NA, .x))

## Only people who started at four years

els<-els%>%filter(f2ps1sec%in%c(1:3))

## create variable for completing a ba

els%>%
   mutate(ba_complete=ifelse(f3attainment%in%c(6,7,8,10),1,0))->els

## average bachelor's completion overall

els%>%summarize(mean(ba_complete))
```

## Split to analysis data

Selecting just the variables desired for the analysis dataset. 
```{r}

##Need to generalize, want a better process for vars
els%>%
   select(ba_complete,
          one_of(keepvars[-(1:4)]),
          -byses1,
          -f3attainment,
          -f2ps1sec 
          )->els_a

```


As with most NCES datasets, this one is almost entirely categorical variables. The code below creates a character vector of the names of variables that have fewer than 20 unique values, then mutates those to be factors. 
```{r}
## set factor variables

## Number of unique values
few_unique<-function(x){
  ifelse(length(unique(x))<20,
         TRUE,
         FALSE)}

## Quickly identify likely factor variables
els_a%>%
   select_if( ~ (few_unique(.)))%>%
   select(-ba_complete)%>%
   names(.)->likely_factors

## Mutate to be factors
els_a%>%
   mutate_at(.vars=likely_factors,.funs=as_factor)->els_a

## Better factor levels for outcome

els_a%>%
   mutate(ba_complete=recode_factor(ba_complete,
                                    "1"="Completed",
                                    "0"="Incomplete"))->els_a
```

## Structure for resampling

Use: https://tidymodels.github.io/rsample/articles/Applications/Recipes_and_rsample.html

Dataset is restructured for 80/20 split, with specified number of bootstrap 
replicates. 

```{r}
boot_reps<-1000

validation_data <- mc_cv(els_a, prop = 0.8, times =boot_reps )
```


## Recipe

Formula is just dv and everything else.

```{r}
ba_complete_formula<-formula("ba_complete~.")
```


```{r}

## NB: Alternatively, a recipe object can be created by first specifying which variables in a data set should be used and then sequentially defining their roles .

recipe_function <- function(dataset, formula, likely_factors) {
   ## recipe function: this function takes a dataset and formula,
   ## then imputes, converts likely factors, and centers and scales
   ## Predictors
   ## datset: duh
   ## formula: formula object
   ## likely_factors: character vector of likely factors
   
   recipe(formula = formula,
          data = dataset) %>%
      step_knnimpute(all_predictors()) %>% #This is dicey, and should be improved, but it's a start. Using K nearest neighbors to impute.
      step_dummy(one_of(likely_factors)) %>% ## Convert factors to dummy
      step_center(all_predictors())  %>%
      step_scale(all_predictors())
}
         
```


```{r}
#H/T: https://www.brodrigues.co/blog/2018-11-25-tidy_cv/


grad_class <- function(formula, likely_factors,split, id) {
   ## Classification function
   ## Takes formula, factor variables (meh) and split/id 
   ## from bootstrapped dtaset.
   ## fits model, generates predictions,
   ## outputs to results dataframe
   pb$tick()$print()
   
   ## Pull analysis dataset from split
   analysis_set <- analysis(split)
   
   ## Prep analysis dataset using recipe function above
   analysis_prep <- prep(recipe_function(analysis_set, 
                                         formula,
                                         likely_factors),
                         training = analysis_set)
   
   ## Output model matrix and outcome
   analysis_processed <-
      bake(analysis_prep, new_data = analysis_set)
   
   logit_fit <- logistic_reg(mode = "classification") %>%
      set_engine("glm") %>%
      fit(formula = formula,
          data = analysis_processed)
   
   ## Prep testing (assessment) dataset
   assessment_set <- assessment(split)
   
   assessment_prep <-
      prep(recipe_function(assessment_set,
                           formula,
                           likely_factors), 
           testing = assessment_set)
   
   assessment_processed <-
      bake(assessment_prep, new_data = assessment_set)
   
   ## Output results as data frame
   tibble(
      "id" = id,
      "truth" = assessment_processed$ba_complete)%>%
         bind_cols(
            predict(logit_fit,
                    new_data=assessment_processed,
                    type="prob"))
}
```

```{r}
pb<-progress_estimated(dim(validation_data[1]))
results <- map2_df(.x = validation_data$splits,
                           .y = validation_data$id,
                           ~grad_class(formula=formula,
                                       likely_factors = likely_factors,
                                       split = .x, 
                                       id = .y))
```


```{r}
results%>%
   group_by(id)%>%
   roc_auc(truth=truth,
           prediction=.pred_Completed)->auc
```

```{r}
gg<-gplot(auc,aes(x=.metric))
gg<-gg+geom_density(fill="lightblue",alpha=.5)
gg
```

